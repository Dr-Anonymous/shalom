---
---

<!DOCTYPE html>
<html>
	<head>
		<style>
			h1 {
			text-align: center;
			}
			.grid-container {
			display: grid;
			grid-template-columns: auto auto auto;
			background-color: #2196F3;
			padding: 10px;
			}
			.grid-item {
			display: grid;
			background-color: rgba(255, 255, 255, 0.8);
			border: 1px solid rgba(0, 0, 0, 0.8);
			padding: 20px 20px 20px 20px;
			font-size: 30px;
			text-align: center;
			}
			.right-top {
			margin-left: auto; 
			}
		</style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	</head>
	<body>
		<h1 onclick="edit();">MIDI controller</h1>
		<div >
			<form from="">
			  <label for="btnName">Button Name:</label>
			  <input type="text" id="btnName">
			  <label for="midiValue">MIDI value:</label>
			  <input type="text" id="midiValue">
			  <input type="button" value="Submit" onclick="">
			</form>
		</div>
		<div class="grid-container">
			<div onclick="sendMidi($(this).text(), $(this).attr('value'));" class="grid-item">1</div>
			<div onclick="sendMidi($(this).text(), $(this).attr('value'));" class="grid-item">2</div>
			<div onclick="addBtn();" class="grid-item">+</div>
		</div>
		<div id="showMessage">
		</div>
		<script>
			let outPort = null,
				editActive = null,
				midi = null;  // global MIDIAccess object
			function onMIDISuccess(midiAccess) {
			  /*console.log("MIDI ready!");*/
			  midi = midiAccess;  // store in the global (in real usage, would probably keep in an object instance)
			  
			  
			  listInputsAndOutputs(midi);
			  startLoggingMIDIInput(midi);
			}
			
			function onMIDIFailure(msg) {
			  console.error(`Failed to get MIDI access - ${msg}`);
			}
			
			navigator.requestMIDIAccess().then(onMIDISuccess, onMIDIFailure);
			
			/* handling input */
			function onMIDIMessage(event) {
			  let str = `MIDI message received ` + /*at timestamp ${event.timeStamp}*/`[${event.data.length} bytes]: `;
			  for (const character of event.data) {
			    let disp = `0x${character.toString(16)} `;
				$("#showMessage").text(disp);
				str += disp;
			  }
			  console.log(str);
			}
			
			function startLoggingMIDIInput(midiAccess, indexOfPort) {
			  midiAccess.inputs.forEach((entry) => {entry.onmidimessage = onMIDIMessage;});
			}
			
			function listInputsAndOutputs(midiAccess) {
			  for (const entry of midiAccess.inputs) {
			    const input = entry[1];
			    console.log(`Input port [type:'${input.type}']` +
			      ` id:'${input.id}'` +
			      ` manufacturer:'${input.manufacturer}'` +
			      ` name:'${input.name}'` +
			      ` version:'${input.version}'`);
			  }
			
			  for (const entry of midiAccess.outputs) {
			    const output = entry[1];
				outPort = output.id;
			    console.log(`Output port [type:'${output.type}'] id:'${output.id}' manufacturer:'${output.manufacturer}' name:'${output.name}' version:'${output.version}'`);
			  }
			}
			
			/* sending output */
			function sendNote(midiAccess, portID) {
			  //const noteOnMessage = [0x90, 60, 0x7f];    // note on, middle C, full velocity
			  const output = midiAccess.outputs.get(portID);
			  output.send(noteOnMessage); // sends the message.
			}
			
			/* custom actions */
			function sendMidi(name, value){
			if (editActive){
			$("#btnName:text").val(name);
			$("#midiValue:text").val(value);
			} else {
			console.log("sending ...");
			}
			}
			
			function edit(){
			if (editActive) {
			clearInterval(editActive);
			editActive = null;
			$('h1')[0].style.opacity = 1;
			return;
			}else {
				editActive = setInterval(function() {
					$('h1')[0].style.opacity = ($('h1')[0].style.opacity == 0 ? 1 : 0);
					}, 500);
				}
			}
			
			function addBtn(){
			console.log("adding...");
			$(".grid-item").last().before(`<div onclick="sendMidi($(this).text(), $(this).attr('value'));" class="grid-item">new</div>`);
			}
			
		</script>
	</body>
</html>
